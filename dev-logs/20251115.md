# 2025.11.15 - 대시보드 API 구현 및 최고 무게 추적 로직 추가

## 1. 대시보드 API 정의 문서 작성

### DEVELOPMENT_DASHBOARD.md 생성

**`dev-prompt/DEVELOPMENT_DASHBOARD.md`** 생성

대시보드 API 구현을 위한 상세 가이드 문서 작성:

**주요 내용:**

1. **API 엔드포인트 정의**
   - `GET /dashboard/activities`: 날짜별 활동 기록 조회
   - `GET /dashboard/achievements`: 최근 5개 achievement 조회

2. **Activity 레벨 정의**
   - `0`: 운동을 하지 않은 날
   - `1`: 운동을 했지만 성취가 없는 날
   - `2`: 성취가 있는 날 (achievement > 0 또는 최고 무게 달성 또는 새 루틴 생성)

3. **Achievement 계산 로직**
   - 같은 `workout_name` && `order`인 운동끼리 비교
   - 각 세트의 `weight * reps` 합산 비교
   - 증량이 있으면 `weight_increase` 기록 및 합산

4. **최고 무게 달성 체크**
   - `workout_personal_records` 테이블을 통한 최고 무게 추적
   - 각 `routine_day_workout`의 모든 세트 중 최대 `weight` 값 계산
   - 기존 `max_weight`와 비교하여 갱신

5. **새로운 루틴 생성 체크**
   - 해당 날짜에 새로운 `routine_pk`가 생성되면 `is_new_routine = true`

6. **여러 루틴 처리**
   - 같은 날짜에 여러 루틴이 있으면 각각 별도의 `DayActivity` 객체로 생성

---

## 2. 기존 문서 업데이트

### DEVELOPMENT_STEPS.md 업데이트

**Phase 4에 추가:**

- Step 4-5: `WorkoutPersonalRecord` 엔티티 생성 단계 추가

**Phase 5에 추가:**

- Step 5-7: 최고 무게 체크 및 업데이트 로직 추가
  - Routines 모듈에 `WorkoutPersonalRecord` 엔티티 등록
  - `checkAndUpdateMaxWeight` 헬퍼 메서드 구현
  - 각 workout 저장 후 최고 무게 체크 호출

**Phase 7에 추가:**

- Step 7-3, 7-4: UPDATE/CREATE 로직에 최고 무게 체크 추가
- Step 7-5: 날짜별 저장에도 최고 무게 체크 포함

**Phase 9 상세화:**

- Step 9-1: 날짜별 활동 기록 조회 기본 구조 상세화
- Step 9-2: `routine_days` 데이터 병합 로직 상세화
- Step 9-3: Achievement 계산 및 Activity 업데이트 로직 추가
  - weight_increase 계산
  - 최고 무게 달성 체크 (이미 저장된 데이터 조회)
  - 새로운 루틴 생성 체크
  - activity 업데이트
- Step 9-4: 최근 Achievement 조회 API 추가

### DEVELOPMENT_GUIDE.md 업데이트

**데이터베이스 스키마 추가:**

- `workout_personal_records` 테이블 스키마 추가

**API 엔드포인트 추가:**

- `GET /dashboard/achievements` 엔드포인트 추가
- API 응답 형식 인터페이스 추가 (`DayActivity`, `MaxWeightRecord`, `AchievementDetail`, `AchievementWorkout`)

**주의사항 추가:**

- "6. 대시보드 구현 주의사항" 섹션 추가
- "8. 대시보드 Activity 및 Achievement" 섹션 추가
  - Activity 레벨 상세 설명
  - Achievement 값의 의미 (null, 0, > 0)
  - 여러 루틴 처리 방법

**백엔드 로직 구현 예시 추가:**

- `checkAndUpdateMaxWeight` 헬퍼 메서드 구현 예시
- `POST /routines` 예시에 최고 무게 체크 로직 추가
- `POST/PATCH /routines/:routine_pk/days/today` 예시에 최고 무게 체크 로직 추가

**검증 체크리스트 추가:**

- 대시보드 API별 검증 항목 추가

---

## 3. 기존 로직 업데이트 (Phase 5, 7)

### WorkoutPersonalRecord 엔티티 생성

**`src/dashboard/entities/workout-personal-record.entity.ts`** 생성

- 필드: `record_pk`, `user_pk`, `workout_name`, `order`, `max_weight`, `achieved_at`, `routine_day_pk`, `created_at`, `updated_at`
- `User`와 `ManyToOne` 관계 설정 (`onDelete: 'CASCADE'`)
- UNIQUE 제약: `(user_pk, workout_name, order)`

**`src/app.module.ts`** 업데이트

- `WorkoutPersonalRecord` 엔티티를 TypeORM entities 배열에 추가

### Routines 서비스에 최고 무게 체크 로직 추가

**`src/routines/routines.service.ts`** 업데이트

**추가된 내용:**

1. **Import 추가**
   - `WorkoutPersonalRecord` 엔티티 import

2. **`checkAndUpdateMaxWeight` 헬퍼 메서드 구현**
   - 파라미터: `manager`, `userId`, `workoutName`, `order`, `currentMaxWeight`, `sessionDate`, `routineDayPk`
   - 기존 최고 무게 기록 조회 (workout_name + order + user_pk 조합)
   - 현재 최고 무게가 기존 `max_weight`보다 크면 갱신
   - 없으면 새 레코드 생성

3. **`createRoutine` 메서드 업데이트**
   - 각 workout 저장 후 `checkAndUpdateMaxWeight` 호출
   - 각 workout의 모든 세트 중 최대 `weight` 값 계산하여 전달

4. **`saveRoutineDayInternal` 메서드 업데이트**
   - 각 workout 저장 후 `checkAndUpdateMaxWeight` 호출
   - UPDATE/CREATE 모두에 적용

**검증:**

- 최고 무게 달성 시 `workout_personal_records` 테이블에 저장 확인
- 루틴 생성/수정 시 최고 무게 자동 추적 확인

---

## 4. Phase 9: 대시보드 API 구현

### Dashboard 모듈 생성

**`src/dashboard/dashboard.module.ts`** 생성

- `Routine`, `RoutineDay`, `WorkoutPersonalRecord` 엔티티를 TypeORM에 등록
- `DashboardController`, `DashboardService` 등록

**`src/app.module.ts`** 업데이트

- `DashboardModule` import 추가

### Dashboard 컨트롤러 구현

**`src/dashboard/dashboard.controller.ts`** 생성

**엔드포인트:**

1. **`GET /dashboard/activities`**
   - `@UseGuards(JwtAuthGuard)` 적용
   - 쿼리 파라미터: `startDate`, `endDate` (필수)
   - `DashboardService.getActivities` 호출

2. **`GET /dashboard/achievements`**
   - `@UseGuards(JwtAuthGuard)` 적용
   - `DashboardService.getAchievements` 호출

### Dashboard 서비스 구현

**`src/dashboard/dashboard.service.ts`** 생성

#### Step 9-1: 날짜별 활동 기록 조회 - 기본

**구현 내용:**

1. 날짜 범위 검증
   - `startDate`, `endDate` 필수 파라미터 검증
   - 날짜 형식 검증 (YYYY-MM-DD)
   - `startDate <= endDate` 검증

2. 날짜 범위 생성
   - `generateDateRange` 메서드로 모든 날짜 배열 생성
   - 각 날짜에 대해 `DayActivity` 객체 초기화
   - 기본값: `activity = 0`, 모든 필드 `null` 또는 `false`

#### Step 9-2: routine_days 데이터 병합

**구현 내용:**

1. 해당 기간의 `routine_days` 조회
   - `user_pk`로 필터링
   - `session_date`가 `startDate`와 `endDate` 사이
   - `routine`, `workouts`, `workouts.sets` relation 포함

2. 데이터 병합
   - 같은 날짜에 여러 루틴이 있으면 각각 별도의 `DayActivity` 객체로 추가
   - `routine_name`, `routine_pk`, `routine_day_pk` 설정
   - `activity` 기본값 1로 설정, `achievement`는 null 유지
   - `has_max_weight_achieved = false`, `max_weight_records = null`, `is_new_routine = false` 초기화

#### Step 9-3: Achievement 계산 및 Activity 업데이트

**구현 내용:**

1. **이전 기록 조회**
   - 현재 날짜보다 이전 날짜만 조회
   - 같은 `routine_pk`의 가장 최근 기록만 사용
   - `workouts`와 `workouts.sets` relation 포함

2. **weight_increase 계산** (`calculateAchievement` 메서드)
   - 같은 `workout_name` && 같은 `order`인 운동 찾기
   - 각 운동의 모든 세트 `weight * reps` 합산 비교
   - 증량이 없으면 `achievement = 0`으로 설정
   - 증량이 있으면 `achievement`에 합산

3. **최고 무게 달성 체크** (`checkMaxWeightAchievement` 메서드)
   - `workout_personal_records` 테이블에서 해당 날짜에 달성한 기록 조회
   - `routine_day_pk` 또는 `achieved_at`이 해당 날짜와 일치하는지 확인
   - 여러 workout에서 최고 무게를 달성했으면 모두 `max_weight_records` 배열에 추가

4. **새로운 루틴 생성 체크** (`checkNewRoutine` 메서드)
   - 해당 `routine_pk`의 `created_at`이 해당 날짜와 같은지 확인
   - 첫 번째 `routine_day`가 해당 날짜인지 확인
   - 새로운 루틴이면 `is_new_routine = true` 설정

5. **activity 업데이트**
   - `achievement > 0` 또는 `has_max_weight_achieved = true` 또는 `is_new_routine = true` 중 하나 이상이면 `activity = 2`
   - 모두 없으면 `activity = 1`
   - `achievement`가 `null`일 때 처리 추가

6. **결과 정렬**
   - 날짜순 정렬
   - 같은 날짜에 여러 루틴이 있으면 `routine_pk` 순으로 정렬하여 일관성 유지

#### Step 9-4: 최근 Achievement 조회 API

**구현 내용:**

1. 현재 사용자의 모든 `routine_days` 조회 (최신순)
   - `routine`, `workouts`, `workouts.sets` relation 포함

2. 각 `routine_day`에 대해 achievement 계산
   - 같은 `routine_pk`의 이전 가장 최근 기록 조회
   - 없으면 스킵
   - 이전 기록이 있으면 `weight * reps` 합산 비교
   - 증량이 있는 workout만 `workouts` 배열에 추가
   - 각 workout에 `weight_increase`, `previous_max_weight`, `current_max_weight` 포함

3. `achievement > 0`인 것만 필터링하여 최대 5개 반환

**반환 형식:**

```typescript
AchievementDetail[] {
  date: string;
  routine_name: string;
  routine_pk: number;
  routine_day_pk: number;
  achievement: number; // 항상 > 0
  workouts: AchievementWorkout[];
}
```

---

## 5. 주요 구현 특징

### 최고 무게 추적 아키텍처

- **저장 시점 (Phase 5, 7)**: 루틴 생성/수정 시 최고 무게 체크 및 `workout_personal_records` 테이블 업데이트
- **조회 시점 (Phase 9)**: 이미 저장된 `workout_personal_records` 테이블을 조회하여 해당 날짜에 달성 여부 확인
- 두 로직이 분리되어 있어 성능과 일관성 확보

### 여러 루틴 처리

- 같은 날짜에 여러 루틴이 있으면 각각 별도의 `DayActivity` 객체로 생성
- 각 루틴은 자신의 이전 기록과만 비교하여 achievement 계산
- 결과는 날짜순, 같은 날짜 내에서는 `routine_pk` 순으로 정렬

### Achievement 계산 정확성

- 같은 `workout_name` && 같은 `order`인 운동끼리만 비교
- 각 세트의 `weight * reps` 합산 비교 (단순 무게가 아님)
- 이전 기록이 없으면 `achievement = null` 유지
- 이전 기록이 있지만 증량이 없으면 `achievement = 0`

---

## 6. 검증 체크리스트

### GET /dashboard/activities

- [x] 날짜 범위의 모든 날짜가 응답에 포함됨
- [x] `routine_day`가 없는 날짜는 `activity = 0`, 모든 필드 null/false
- [x] `routine_day`가 있지만 성취가 없으면 `activity = 1`
- [x] `achievement > 0` 또는 최고 무게 달성 또는 새로운 루틴 생성 시 `activity = 2`
- [x] 새로운 루틴 생성 시 `achievement = null`이어도 `activity = 2`
- [x] 모든 응답에 `has_max_weight_achieved`, `max_weight_records`, `is_new_routine` 필드 포함
- [x] 최고 무게 달성 시 `has_max_weight_achieved = true` 및 `max_weight_records` 배열에 정보 포함
- [x] 같은 날짜에 여러 루틴이 있으면 각각 별도 항목으로 반환
- [x] 같은 `workout_name` && 같은 `order`만 비교
- [x] 각 운동의 모든 세트 `weight * reps` 합산을 비교하여 증량 계산

### GET /dashboard/achievements

- [x] `achievement > 0`인 기록만 반환됨
- [x] 날짜 기준 내림차순 정렬 (최신순)
- [x] 최대 5개만 반환됨
- [x] 각 achievement에 `workouts` 배열이 포함됨
- [x] 모든 workout의 `weight_increase` 합이 `achievement`와 일치함
- [x] 각 workout에 `previous_max_weight`, `current_max_weight` 필드 포함

---

## 7. 향후 과제

- 대시보드 API 성능 최적화 (N+1 쿼리 개선)
- 대용량 날짜 범위 조회 시 성능 테스트
- 통합 테스트 작성
- Phase 10 (최적화) 단계 진행
