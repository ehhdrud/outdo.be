# 2025.11.05 - 인증 시스템 완료 및 코드 품질 개선

## 1. Step 2-4: JWT 인증 가드 구현

### JwtAuthGuard 확인 및 테스트 엔드포인트 추가

**`src/common/guards/jwt-auth.guard.ts`** 확인

- 이미 구현되어 있었음
- `@Public()` 데코레이터 지원
- `Reflector`를 사용한 메타데이터 기반 공개 엔드포인트 처리

### 테스트 엔드포인트 구현

**`src/app.controller.ts`** 업데이트

**추가된 엔드포인트:**

- `GET /test/auth`: JWT 인증 테스트 엔드포인트
  - `@UseGuards(JwtAuthGuard)` 적용
  - `@User()` 데코레이터로 현재 사용자 정보 추출
  - 인증된 사용자 정보 반환

**구현 코드:**

```typescript
@UseGuards(JwtAuthGuard)
@Get('test/auth')
testAuth(@User() user: UserPayload) {
  return {
    message: 'JWT 인증 성공',
    user: {
      user_pk: user.user_pk,
      email: user.email,
    },
  };
}
```

**검증:**

- 토큰 없이 요청 시 401 Unauthorized 반환
- 유효한 토큰으로 요청 시 사용자 정보 반환

---

## 2. Step 2-5: 토큰 갱신 API 구현

### RenewalTokenDto 생성

**`src/auth/dto/renewal-token.dto.ts`** 생성

- `refresh_token`: Refresh Token (필수, 문자열)
- Validation 데코레이터 적용

### AuthService.renewalToken 메서드 구현

**`src/auth/auth.service.ts`**

**구현 로직:**

1. Refresh Token JWT 검증 (`jwtService.verify`)
2. Payload 검증 (`sub`, `email`, `type: 'refresh'` 확인)
3. DB에서 Refresh Token 조회 (토큰 문자열 및 user_pk로 검색)
4. 만료 확인 (`expires_at`과 현재 시간 비교)
5. 만료된 토큰은 DB에서 자동 삭제
6. 사용자 정보 조회
7. 새로운 Access Token 발급

**반환 값:**

```typescript
{
  access_token: string;
}
```

### AuthController 엔드포인트 추가

**`src/auth/auth.controller.ts`**

- `POST /auth/renewalToken` 엔드포인트 생성
- `@Public()` 데코레이터 적용 (인증 없이 접근 가능)
- RenewalTokenDto를 받아서 처리

**검증:**

- 유효한 Refresh Token으로 새 Access Token 발급 확인
- 유효하지 않은/만료된 Refresh Token 시 401 에러 반환

---

## 3. Step 2-6: 비밀번호 변경 API 구현

### ChangePasswordDto 생성

**`src/auth/dto/change-password.dto.ts`** 생성

- `current_password`: 현재 비밀번호 (필수, 문자열)
- `new_password`: 새 비밀번호 (필수, 문자열, 최소 6자)
- Validation 데코레이터 적용

### AuthService.changePassword 메서드 구현

**`src/auth/auth.service.ts`**

**구현 로직:**

1. 사용자 조회 (user_pk로)
2. 비밀번호가 없는 경우 체크 (구글 로그인 등)
3. 현재 비밀번호 검증 (`bcrypt.compare`)
4. 새 비밀번호 해싱 (`bcrypt.hash`, saltRounds: 10)
5. 비밀번호 업데이트

**반환 값:**

```typescript
{
  message: string;
}
```

### AuthController 엔드포인트 추가

**`src/auth/auth.controller.ts`**

- `POST /auth/changePassword` 엔드포인트 생성
- `@UseGuards(JwtAuthGuard)` 적용 (인증 필요)
- `@User()` 데코레이터로 현재 사용자 정보 추출
- ChangePasswordDto를 받아서 처리

**검증:**

- 비밀번호 변경 후 새 비밀번호로 로그인 성공 확인
- 잘못된 현재 비밀번호 시 401 에러 반환
- 비밀번호 없는 계정(구글 로그인) 시 적절한 에러 메시지 반환

---

## 4. 전체 구현 검토 및 버그 수정

### 발견된 문제점

#### 4-1. JWT Payload 불일치 문제 (치명적)

**문제:**

- `auth.service.ts`에서 JWT 토큰 발급 시 `sub` 필드 사용: `{ sub: user.user_pk, email: user.email }`
- `jwt.strategy.ts`에서 `user_pk` 필드를 기대: `payload.user_pk`
- JWT 인증이 정상적으로 동작하지 않을 수 있는 심각한 문제

**해결 방법:**

**`src/auth/jwt.strategy.ts`** 수정

```typescript
export interface JwtPayload {
  sub: number; // user_pk (JWT 표준: subject)
  email: string;
  user_pk?: number; // 하위 호환성을 위한 필드 (선택적)
}

async validate(payload: JwtPayload) {
  // sub (JWT 표준) 또는 user_pk (하위 호환성) 사용
  const userPk = payload.sub || payload.user_pk;

  if (!userPk || !payload.email) {
    throw new UnauthorizedException('Invalid token payload');
  }

  return {
    user_pk: userPk,
    email: payload.email,
  };
}
```

**결과:**

- JWT 표준(`sub`)을 따르면서 하위 호환성도 유지
- JWT 인증이 정상적으로 동작

#### 4-2. 타입 안전성 개선

**문제:**

- `signup` 메서드에서 password 삭제 시 `any` 타입 사용
- 타입 안전성이 떨어짐

**해결 방법:**

**`src/auth/auth.service.ts`** 수정

**Before:**

```typescript
delete (savedUser as any).password;
return savedUser;
```

**After:**

```typescript
const { password, ...userWithoutPassword } = savedUser;
return userWithoutPassword as Omit<User, 'password'>;
```

**결과:**

- 타입 안전성 향상
- `any` 타입 사용 제거

#### 4-3. 보안 강화

**문제:**

- `signin` 메서드에서 비밀번호가 없는 사용자(구글 로그인)에 대한 처리 누락
- 구글 로그인 사용자가 일반 로그인을 시도할 경우 잘못된 동작 가능

**해결 방법:**

**`src/auth/auth.service.ts`** 수정

**추가된 로직:**

```typescript
// 2. 비밀번호가 없는 경우 (구글 로그인 등) 체크
if (!user.password) {
  throw new UnauthorizedException('이메일 또는 비밀번호가 올바르지 않습니다');
}
```

**결과:**

- 구글 로그인 사용자의 일반 로그인 시도 시 적절한 에러 반환
- 보안 강화

---

## 5. 구현 완료 상태

### Phase 2: 인증 시스템 (완료)

**구현된 API:**

1. ✅ `POST /auth/signup` - 회원가입
2. ✅ `POST /auth/signin` - 일반 로그인
3. ✅ `GET /auth/google` - 구글 로그인 시작
4. ✅ `GET /auth/google/callback` - 구글 로그인 콜백
5. ✅ `POST /auth/renewalToken` - 토큰 갱신
6. ✅ `POST /auth/changePassword` - 비밀번호 변경 (인증 필요)

**공통 기능:**

- ✅ JWT 인증 가드 (`JwtAuthGuard`)
- ✅ `@Public()` 데코레이터 (공개 엔드포인트)
- ✅ `@User()` 데코레이터 (현재 사용자 정보 추출)
- ✅ 공통 응답 포맷 (TransformInterceptor)
- ✅ 에러 처리 (HttpExceptionFilter)

---

## 6. 코드 품질 평가

### 강점

1. **보안**: ⭐⭐⭐⭐⭐
   - bcrypt 해싱 (saltRounds: 10)
   - JWT 토큰 관리 (Access/Refresh 분리)
   - Refresh Token DB 저장 및 만료 관리
   - 적절한 비밀번호 검증

2. **에러 처리**: ⭐⭐⭐⭐⭐
   - 일관된 에러 응답 포맷
   - 적절한 HTTP 상태 코드 사용
   - 명확한 에러 메시지

3. **코드 구조**: ⭐⭐⭐⭐⭐
   - NestJS 모범 사례 준수
   - 모듈화 및 의존성 주입
   - DTO 검증 (class-validator)

4. **타입 안전성**: ⭐⭐⭐⭐☆
   - 대부분 타입 안전
   - `any` 타입 사용 최소화

### 개선 권장 사항

1. **Refresh Token 관리**
   - 현재: Refresh Token이 계속 누적됨
   - 권장: 같은 사용자의 기존 Refresh Token 삭제 또는 로그아웃 시 삭제 로직 추가

2. **환경 변수 검증**
   - 현재: 환경 변수 없을 시 기본값 사용
   - 권장: 애플리케이션 시작 시 필수 환경 변수 검증

3. **로깅**
   - 현재: SQL 로그만 출력
   - 권장: 인증 실패, 토큰 갱신 등 중요 이벤트 로깅

4. **Rate Limiting**
   - 현재: 없음
   - 권장: 로그인, 회원가입 등에 Rate Limiting 적용

---

## 7. 다음 단계

**Phase 3: 사용자 관리 (Users)**

- Step 3-1: 프로필 조회 API (`GET /users/profile`)
- Step 3-2: 프로필 수정 API (`PATCH /users/profile`)

---

## 8. 검증 방법

### JWT 인증 가드 테스트

```bash
# 토큰 없이 요청 (401 에러)
GET http://localhost:3000/test/auth

# 유효한 토큰으로 요청 (성공)
GET http://localhost:3000/test/auth
Headers: Authorization: Bearer <access_token>
```

### 토큰 갱신 테스트

```bash
# 유효한 Refresh Token으로 요청
POST http://localhost:3000/auth/renewalToken
Body: {
  "refresh_token": "<refresh_token>"
}

# 응답: 새 Access Token 반환
```

### 비밀번호 변경 테스트

```bash
# 비밀번호 변경
POST http://localhost:3000/auth/changePassword
Headers: Authorization: Bearer <access_token>
Body: {
  "current_password": "현재비밀번호",
  "new_password": "새비밀번호123"
}

# 새 비밀번호로 로그인 확인
POST http://localhost:3000/auth/signin
Body: {
  "email": "user@example.com",
  "password": "새비밀번호123"
}
```

---

## 9. 수정된 파일 목록

1. `src/app.controller.ts` - JWT 인증 테스트 엔드포인트 추가
2. `src/auth/dto/renewal-token.dto.ts` - 새로 생성
3. `src/auth/dto/change-password.dto.ts` - 새로 생성
4. `src/auth/auth.service.ts` - renewalToken, changePassword 메서드 추가, signin 보안 강화, signup 타입 안전성 개선
5. `src/auth/auth.controller.ts` - renewalToken, changePassword 엔드포인트 추가
6. `src/auth/jwt.strategy.ts` - JWT Payload 불일치 문제 수정
