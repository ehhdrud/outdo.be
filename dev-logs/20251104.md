# 2025.11.04 - 인증 시스템 구현 완료 (일반 로그인 + 구글 로그인)

## 1. 개발 환경 설정 개선

### ESLint 라인 엔딩 오류 해결

**문제:**

- Windows 환경에서 CRLF (`\r\n`) 라인 엔딩 사용
- ESLint/Prettier는 LF (`\n`) 기대
- 모든 파일에서 `Delete ␍` 에러 발생

**해결 방법:**

**`.prettierrc`** 업데이트:

```json
{
  "singleQuote": true,
  "trailingComma": "all",
  "printWidth": 100,
  "endOfLine": "lf"
}
```

**`.editorconfig`** 파일 생성:

```
root = true

[*]
charset = utf-8
end_of_line = lf
insert_final_newline = true
trim_trailing_whitespace = true

[*.md]
trim_trailing_whitespace = false
```

**결과:**

- 프로젝트 전체 파일 라인 엔딩을 LF로 통일
- ESLint 에러 해결
- 향후 생성되는 파일도 자동으로 LF 사용

---

## 2. Step 2-3: 일반 로그인 API 구현

### SigninDto 생성

**`src/auth/dto/signin.dto.ts`** 생성

- `email`: 이메일 (필수, 이메일 형식 검증)
- `password`: 비밀번호 (필수, 문자열)
- Validation 데코레이터 적용

### AuthService.signin 메서드 구현

**`src/auth/auth.service.ts`**

**구현 로직:**

1. 이메일로 사용자 조회
2. 사용자 없으면 `UnauthorizedException` 발생
3. 비밀번호 검증 (`bcrypt.compare`)
4. 비밀번호 불일치 시 `UnauthorizedException` 발생
5. Access Token 발급 (JWT, 기본 만료 시간)
6. Refresh Token 발급 (7일 만료)
7. Refresh Token DB 저장 (`refresh_tokens` 테이블)

**반환 값:**

```typescript
{
  access_token: string;
  refresh_token: string;
}
```

### AuthController 엔드포인트 추가

**`src/auth/auth.controller.ts`**

- `POST /auth/signin` 엔드포인트 생성
- `@Public()` 데코레이터 적용 (인증 없이 접근 가능)
- SigninDto를 받아서 처리

**검증:**

- 로그인 성공 시 토큰 2개 반환 확인
- 잘못된 이메일/비밀번호 시 401 에러 반환

---

## 3. Step 2-3-1: 구글 로그인 API 구현

### 패키지 설치

```bash
npm install passport-google-oauth20
npm install --save-dev @types/passport-google-oauth20
```

### User 엔티티 생성 및 확장

**`src/users/entities/user.entity.ts`** 생성

- `user_pk`: Primary Key
- `email`: 이메일 (unique)
- `password`: 비밀번호 (nullable - 구글 로그인 사용자용)
- `name`: 이름
- `bio`: 자기소개 (nullable)
- `google_id`: 구글 ID (nullable, unique)
- `refreshTokens`: RefreshToken과의 관계

**주요 특징:**

- 구글 로그인 사용자는 `password`가 `null`
- 일반 회원가입 사용자는 `password`가 해싱된 값
- `google_id`는 unique 제약으로 중복 방지

### Google OAuth Strategy 구현

**`src/auth/google.strategy.ts`** 생성

**구현 내용:**

- `PassportStrategy` 상속 (Strategy: 'google')
- 환경 변수에서 설정 읽기:
  - `GOOGLE_CLIENT_ID`
  - `GOOGLE_CLIENT_SECRET`
  - `GOOGLE_CALLBACK_URL` (기본값: `/auth/google/callback`)
- Scope: `['email', 'profile']`
- `validate` 메서드에서 구글 사용자 정보 추출:
  - `google_id`: 구글 ID
  - `email`: 이메일
  - `name`: 이름 (givenName + familyName)

### AuthService.googleLogin 메서드 구현

**`src/auth/auth.service.ts`**

**구현 로직:**

1. `google_id`로 기존 회원 확인
2. 없으면 `email`로 확인
3. `email`로 찾았으면 `google_id` 업데이트 (기존 회원에 구글 연동)
4. 둘 다 없으면 신규 회원가입
   - `password`: `null` (구글 로그인은 비밀번호 없음)
   - `google_id`, `email`, `name` 저장
5. Access Token 발급
6. Refresh Token 발급 및 DB 저장

**주요 특징:**

- 기존 이메일 회원가입 사용자가 구글 로그인 시 자동 연동
- 신규 구글 사용자는 자동 회원가입
- 일반 로그인과 동일한 토큰 발급 로직 사용

### AuthController 구글 로그인 엔드포인트 추가

**`src/auth/auth.controller.ts`**

**엔드포인트:**

- `GET /auth/google`: 구글 로그인 시작
  - `@UseGuards(AuthGuard('google'))` 적용
  - Passport가 자동으로 구글 OAuth 페이지로 리다이렉트
- `GET /auth/google/callback`: 구글 로그인 콜백
  - `@UseGuards(AuthGuard('google'))` 적용
  - `req.user`에서 구글 사용자 정보 받음
  - `googleLogin` 메서드 호출하여 토큰 발급
  - 토큰과 리다이렉트 URL 반환

**응답 형식:**

```typescript
{
  access_token: string;
  refresh_token: string;
  redirect_url: string; // 프론트엔드로 리다이렉트할 URL
}
```

### AuthModule 업데이트

**`src/auth/auth.module.ts`**

- `GoogleStrategy` import 추가
- `providers`에 `GoogleStrategy` 추가

---

## 4. 문서 업데이트

### DEVELOPMENT_STEPS.md

**추가 내용:**

- Step 2-3-1: 구글 로그인 API 구현 체크리스트 추가
- Step 0-1: 환경 변수 설정에 구글 OAuth 설정 가이드 추가

**구글 OAuth 설정 방법:**

1. Google Cloud Console에서 프로젝트 생성
2. OAuth 2.0 클라이언트 ID 만들기 (애플리케이션 유형: 웹 애플리케이션)
3. 승인된 리디렉션 URI에 `http://localhost:3000/auth/google/callback` 추가
4. Client ID와 Client Secret을 `.env`에 설정

### DEVELOPMENT_GUIDE.md

**API 엔드포인트 테이블 업데이트:**

- 인증 섹션에 구글 로그인 엔드포인트 추가
- 구글 로그인 플로우 설명 추가

**구글 로그인 플로우:**

1. 사용자가 `/auth/google`로 접근
2. 구글 OAuth 인증 페이지로 리다이렉트
3. 사용자 승인 후 `/auth/google/callback`으로 리다이렉트
4. 구글 사용자 정보로 기존 회원 확인 또는 신규 회원가입
5. Access Token 및 Refresh Token 발급 후 반환

### README.md

**추가 내용:**

- 환경 변수 설정 섹션 추가
  - 데이터베이스 설정
  - JWT 설정
  - 구글 OAuth 설정
- 기본 엔드포인트 섹션 업데이트
  - 인증 엔드포인트 목록
  - 구글 로그인 엔드포인트 설명

---

## 5. 현재 진행 상황

### 완료된 Phase

- ✅ **Phase 0**: 프로젝트 기본 설정
  - Step 0-1: 환경 변수 설정 ✅
  - Step 0-2: TypeORM 설정 ✅
  - Step 0-3: 공통 응답 포맷 설정 ✅

- ✅ **Phase 1**: 데이터베이스 엔티티 (인증)
  - Step 1-1: User 엔티티 생성 ✅
  - Step 1-2: RefreshToken 엔티티 생성 ✅

- ✅ **Phase 2**: 인증 시스템 (진행 중)
  - Step 2-1: JWT 모듈 설정 ✅
  - Step 2-2: 회원가입 API ✅
  - Step 2-3: 로그인 API ✅
  - Step 2-3-1: 구글 로그인 API ✅

### 다음 단계

- Step 2-4: JWT 인증 가드
- Step 2-5: 토큰 갱신 API
- Step 2-6: 비밀번호 변경 API

---

## 6. 주요 이슈 및 해결

### 이슈 1: ESLint 라인 엔딩 오류

**문제:** Windows 환경에서 CRLF 사용으로 인한 ESLint 에러

**해결:**

- `.prettierrc`에 `endOfLine: "lf"` 추가
- `.editorconfig` 파일 생성
- `npm run format`으로 전체 파일 포맷팅

### 이슈 2: User 엔티티 파일 누락

**문제:** `auth.service.ts`에서 User 엔티티를 import하지만 파일이 없음

**해결:**

- `src/users/entities/user.entity.ts` 생성
- Step 1-1의 요구사항에 따라 구현
- 구글 로그인을 위해 `google_id` 필드 추가

---

## 7. 테스트 체크리스트

### 일반 로그인

- [ ] 올바른 이메일/비밀번호로 로그인 성공
- [ ] 잘못된 이메일로 로그인 시 401 에러
- [ ] 잘못된 비밀번호로 로그인 시 401 에러
- [ ] 로그인 성공 시 `access_token`과 `refresh_token` 반환 확인
- [ ] DB에 `refresh_tokens` 테이블에 토큰 저장 확인

### 구글 로그인

- [ ] `/auth/google` 접근 시 구글 로그인 페이지로 리다이렉트
- [ ] 구글 로그인 성공 후 콜백에서 토큰 반환
- [ ] 신규 구글 사용자 자동 회원가입 확인
- [ ] 기존 이메일 회원에 구글 연동 확인
- [ ] DB에 `google_id` 저장 확인

---

## 8. 환경 변수 추가 필요

`.env` 파일에 다음 변수 추가:

```env
# 구글 OAuth
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
GOOGLE_CALLBACK_URL=http://localhost:3000/auth/google/callback

# 프론트엔드 URL (선택)
FRONTEND_URL=http://localhost:5173
```

---

## 9. 참고 사항

### 구글 OAuth 클라이언트 ID 생성 시

- **애플리케이션 유형:** 웹 애플리케이션
- **승인된 리디렉션 URI:** `http://localhost:3000/auth/google/callback` (개발 환경)
- 운영 환경에서는 실제 도메인으로 변경 필요

### 구글 로그인 동작 방식

1. **기존 이메일 회원 + 구글 로그인:**
   - 이메일로 사용자 찾기
   - `google_id` 업데이트
   - 이후 구글 로그인 가능

2. **신규 구글 사용자:**
   - 자동 회원가입
   - `password`는 `null`
   - 일반 로그인 불가 (비밀번호 없음)

3. **토큰 발급:**
   - 일반 로그인과 동일한 방식
   - Access Token (기본 만료 시간)
   - Refresh Token (7일 만료)

---

## 10. 다음 작업 예정

1. Step 2-4: JWT 인증 가드 구현
2. Step 2-5: 토큰 갱신 API 구현
3. Step 2-6: 비밀번호 변경 API 구현
4. 프론트엔드와 구글 로그인 연동 테스트
