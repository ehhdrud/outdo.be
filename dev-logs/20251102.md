# 2025.11.02 - Outdo 백엔드 개발 시작

## 1. 요구사항 정의

### 요구사항 문서 작성

**`dev-prompt/ROUTINE_REQUIREMENTS.md`** 작성

- 루틴 관리 시스템 핵심 동작 정의
- 단일 `routine_pk`로 루틴 정의
- 날짜별 실행 기록 분리 관리 (`routine_days` 테이블)
- 화면별 동작 시나리오 정의

**주요 내용:**

- 루틴 이름 중복 방지: 같은 사용자는 같은 이름의 루틴 1개만
- 다른 이름의 루틴은 같은 날짜에 여러 개 생성 가능
- 해당 `routine_pk`의 해당 날짜 기록이 있으면 UPDATE, 없으면 CREATE

### 백엔드 구성 계획서 작성

**`dev-prompt/BACKEND_SETTING.md`** 작성 (초기 버전)

- 데이터베이스 스키마 설계
- API 엔드포인트 설계
- NestJS 모듈 구조 정의

### 문서 통합 및 개선

**`dev-prompt/DEVELOPMENT_GUIDE.md`** 생성

- 요구사항과 백엔드 설계를 하나로 통합
- 요구사항부터 구현까지 모든 내용 포함
- 중복 제거 및 간소화

**`dev-prompt/DEVELOPMENT_STEPS.md`** 생성

- 개발 단계를 50+ Step으로 세분화
- 각 Step별 명확한 목표와 검증 방법 정의
- Phase별 체크리스트 제공

---

## 2. 프로젝트 기본 설정

### 환경 변수 설정

**`.env`** 파일 생성:

```env
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=your_password
DB_DATABASE=outdo_db

JWT_SECRET=your-super-secret-jwt-key
JWT_EXPIRES_IN=1h
REFRESH_TOKEN_EXPIRES_IN=7d

PORT=3000
```

### TypeORM 설정

**`src/app.module.ts`**

- ConfigModule 설정 (글로벌)
- TypeORM 연결 설정
- 엔티티 명시적 등록 (`User`, `RefreshToken`)

### 공통 응답 포맷 설정

**`src/common/interceptors/transform.interceptor.ts`** 생성

- 성공 응답: `{ success: true, data: ... }`

**`src/common/filters/http-exception.filter.ts`** 생성

- 에러 응답: `{ success: false, message: ..., extras: { rs_code: ... } }`

**`src/main.ts`** 업데이트

- 글로벌 인터셉터 및 필터 등록
- ValidationPipe 등록 (DTO 검증)

---

## 3. 데이터베이스 엔티티 생성

### User 엔티티

**`src/users/entities/user.entity.ts`** 생성

```typescript
@Entity('users')
export class User {
  @PrimaryGeneratedColumn({ name: 'user_pk' })
  user_pk: number;

  @Column({ type: 'varchar', length: 255, unique: true })
  email: string;

  @Column({ type: 'varchar', length: 255 })
  password: string;

  @Column({ type: 'varchar', length: 100 })
  name: string;

  @Column({ type: 'text', nullable: true })
  bio: string | null;

  @OneToMany(() => RefreshToken, (refreshToken) => refreshToken.user)
  refreshTokens: RefreshToken[];
}
```

**특징:**

- `email` UNIQUE 제약
- `created_at`, `updated_at` 제거 (DEVELOPMENT_GUIDE.md 기준)

### RefreshToken 엔티티

**`src/auth/entities/refresh-token.entity.ts`** 생성

```typescript
@Entity('refresh_tokens')
@Index(['user_pk', 'token'])
export class RefreshToken {
  @PrimaryGeneratedColumn({ name: 'token_pk' })
  token_pk: number;

  @Column({ name: 'user_pk' })
  user_pk: number;

  @Column({ type: 'varchar', length: 500 })
  token: string;

  @Column({ name: 'expires_at', type: 'timestamp' })
  expires_at: Date;

  @Column({
    name: 'created_at',
    type: 'datetime',
    nullable: false,
  })
  created_at: Date;

  @ManyToOne(() => User, (user) => user.refreshTokens, {
    onDelete: 'CASCADE',
  })
  @JoinColumn({ name: 'user_pk' })
  user: User;
}
```

**특징:**

- `(user_pk, token)` 인덱스
- `created_at`은 애플리케이션에서 직접 설정

**이슈 해결:**

- 초기 `timestamp` 타입 사용 시 "Invalid default value" 에러
- `datetime` 타입으로 변경 및 default 제거하여 해결

---

## 4. 인증 시스템 구현

### JWT 모듈 설정

**패키지 설치:**

```bash
npm install @nestjs/jwt @nestjs/passport passport passport-jwt bcrypt
npm install --save-dev @types/passport-jwt @types/bcrypt
```

**`src/auth/jwt.strategy.ts`** 생성

- JWT 검증 로직 구현
- Payload에서 `user_pk`, `email` 추출

**`src/auth/auth.module.ts`** 생성

- JWT 모듈 설정 (환경 변수에서 SECRET 읽기)
- Passport 모듈 등록
- TypeORM 엔티티 등록

**`src/common/guards/jwt-auth.guard.ts`** 생성

- JWT 인증 가드 구현
- `@Public()` 데코레이터 지원

**`src/common/decorators/public.decorator.ts`** 생성

- 인증 없이 접근 가능한 엔드포인트 표시

**`src/common/decorators/user.decorator.ts`** 생성

- 현재 사용자 정보 추출 데코레이터

**이슈 해결:**

- JWT 모듈 `expiresIn` 타입 에러: `JwtModuleOptions` 반환 타입 명시 및 `as any` 사용
- JWT_SECRET 누락 에러: 기본값 추가

### 회원가입 API

**`src/auth/dto/signup.dto.ts`** 생성

- `email`, `password`, `name` 필드
- Validation 데코레이터 추가

**`src/auth/auth.service.ts`** - signup 메서드 구현

- 이메일 중복 확인
- 비밀번호 해싱 (bcrypt, saltRounds: 10)
- User 생성
- 응답에서 password 제외

**`src/auth/auth.controller.ts`** - signup 엔드포인트

- `POST /auth/signup`
- `@Public()` 데코레이터 적용

---

## 5. 현재 진행 상황

### 완료된 Phase

- ✅ **Phase 0**: 프로젝트 기본 설정
  - Step 0-1: 환경 변수 설정
  - Step 0-2: TypeORM 설정
  - Step 0-3: 공통 응답 포맷 설정

- ✅ **Phase 1**: 데이터베이스 엔티티 (인증)
  - Step 1-1: User 엔티티 생성
  - Step 1-2: RefreshToken 엔티티 생성

- ✅ **Phase 2**: 인증 시스템 (진행 중)
  - Step 2-1: JWT 모듈 설정 ✅
  - Step 2-2: 회원가입 API ✅

### 다음 단계

- **Step 2-3**: 로그인 API
- **Step 2-4**: JWT 인증 가드 테스트
- **Step 2-5**: 토큰 갱신 API
- **Step 2-6**: 비밀번호 변경 API

---

## 6. 테이블 구조 확인

### 생성된 테이블

**MySQL Workbench에서 확인:**

```sql
USE outdo_db;
SHOW TABLES;
```

**결과:**

- `users` ✅
- `refresh_tokens` ✅
- `typeorm_metadata` (TypeORM 자동 생성)

**테이블 구조 확인:**

```sql
DESCRIBE users;
DESCRIBE refresh_tokens;
```

---

## 7. 구현 파일 구조

```
src/
├── app.module.ts
├── main.ts
├── common/
│   ├── decorators/
│   │   ├── public.decorator.ts
│   │   └── user.decorator.ts
│   ├── filters/
│   │   └── http-exception.filter.ts
│   ├── guards/
│   │   └── jwt-auth.guard.ts
│   └── interceptors/
│       └── transform.interceptor.ts
├── auth/
│   ├── auth.module.ts
│   ├── auth.controller.ts
│   ├── auth.service.ts
│   ├── jwt.strategy.ts
│   ├── dto/
│   │   └── signup.dto.ts
│   └── entities/
│       └── refresh-token.entity.ts
└── users/
    └── entities/
        └── user.entity.ts
```

---

## 8. 주요 설정 값

### JWT 설정

- Access Token 만료: `1h`
- Refresh Token 만료: `7d`
- Secret 키: 환경 변수에서 읽기

### 데이터베이스 설정

- TypeORM `synchronize: true` (개발 환경)
- `autoLoadEntities: true`
- `logging: true` (SQL 쿼리 로그)

### 보안 설정

- CORS: `http://localhost:5173`
- `credentials: true`
- 비밀번호 해싱: bcrypt (saltRounds: 10)
